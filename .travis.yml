language: python
sudo: false
python:
- 2.7

install:
- pip install -r requirements.txt

script:
- | # freeze subl.ee
  rm -rf .frozen && mkdir .frozen
  python sublee.py freeze .frozen

- | # prepare subl.ee gh-pages
  mkdir .gh-pages-subl.ee
  pushd .gh-pages-subl.ee
    cp -r ../.frozen/* .
  popd

- | # archive at archives.subl.ee
  SHORT_COMMIT="$(git rev-parse --short "$TRAVIS_COMMIT")"
  git clone "https://sublee:$GITHUB_TOKEN@github.com/sublee/subl.ee-archives"
  pushd subl.ee-archives
    cp -r ../.frozen "$SHORT_COMMIT"

    python archives.py preserve "$SHORT_COMMIT"
    python archives.py index > index.html

    git add "$SHORT_COMMIT"
    git add index.html

    git commit -m "Archive at https://archives.subl.ee/$SHORT_COMMIT"
    git push origin master > /dev/null 2>&1
  popd

deploy:
  # subl.ee
  - provider: pages
    skip_cleanup: true
    github_token: $GITHUB_TOKEN
    local_dir: .gh-pages-subl.ee
    on:
      branch: master
